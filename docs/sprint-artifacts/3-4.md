# Story 3.4: Download Chat History

Status: ready-for-dev

## Story

As a student,
I want to download my chat history,
so that I can save it and look at it later.

## Acceptance Criteria

(Source: `docs/sprint-artifacts/tech-spec-epic-3.md#acceptance-criteria-authoritative`)
1. A "Download Chat" button is available within the options modal.
2. After a conversation, clicking the "Download Chat" button triggers a download of a `.txt` file containing the full chat log.
3. The downloaded `.txt` file includes timestamps and distinguishes between user and bot messages.

## Tasks / Subtasks

- [ ] **Frontend: Implement "Download Chat" Button and Modal Logic** (AC: 1)
  - [ ] Create or update the `OptionsModalModule` component.
  - [ ] Add a "Download Chat" button to the modal, styled as a secondary action as per the UX Design Specification.
  - [ ] On button click, trigger the chat history download process.
- [ ] **Frontend: Implement Chat History Download Logic** (AC: 2, 3)
  - [ ] Create a function to make a `GET` request to the `/api/chat/history/{sessionId}` endpoint.
  - [ ] On receiving the chat history data (`ChatMessage[]`), format it into a `.txt` string, ensuring timestamps and sender (`user`/`bot`) are included for each message.
  - [ ] Implement client-side logic to create a blob from the formatted string and trigger the browser's file download.
- [ ] **Backend: Implement Chat History API Endpoint** (AC: 2, 3)
  - [ ] Create the `GET /api/chat/history/{sessionId}` endpoint in the Next.js API routes.
  - [ ] Implement the service logic to retrieve all `ChatMessage`s for a given `sessionId` from the database (Supabase).
  - [ ] Ensure the endpoint returns the chat messages in the correct `ChatMessage[]` format as defined in the architecture.
- [ ] **Testing**
  - [ ] **Unit Test**: `OptionsModalModule` to verify button presence and click handler.
  - [ ] **Unit Test**: Frontend formatting function to ensure correct `.txt` output.
  - [ ] **Integration Test**: Backend API endpoint `GET /api/chat/history/{sessionId}`.
  - [ ] **E2E Test**: Full user journey: chat -> open modal -> click download -> verify downloaded file content.

## Dev Notes

- **Functional Requirement:** This story directly implements **FR009**: "The ability for students to download their chatlog locally."
- **Architecture:** This feature requires local file system interaction for the download. The backend will expose a REST endpoint `GET /api/chat/history/{sessionId}` to provide the chat history data. The data models `ChatSession` and `ChatMessage` will be used.
- **UX Integration:** The "Download Chat" button will be placed within the "Options" modal, styled as a secondary action.
- **Component Reusability:** The existing `Dialog` component from Shadcn UI should be used for the `OptionsModalModule`.
- **Accessibility:** Ensure the download functionality and button are keyboard navigable and screen reader accessible (WCAG 2.1 Level AA compliant).
- **Performance:** The chat history should be retrieved efficiently from the backend to avoid UI freezes.

### Project Structure Notes

- **API Route:** The new backend endpoint should be located at `src/app/api/chat/history/[sessionId]/route.ts`.
- **Frontend Logic:** The logic for fetching and downloading the chat history should be encapsulated within the `OptionsModalModule` or a dedicated service hook (e.g., `useChatHistory`).

### References

- [Source: `docs/fase-2-plan/PRD.md#functional-requirements-mvp`]
- [Source: `docs/fase-3-solutioning/architecture.md#epic-to-architecture-mapping`]
- [Source: `docs/fase-3-solutioning/architecture.md#api-contracts`]
- [Source: `docs/sprint-artifacts/tech-spec-epic-3.md#detailed-design`]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## Change Log

- Initial draft created.
