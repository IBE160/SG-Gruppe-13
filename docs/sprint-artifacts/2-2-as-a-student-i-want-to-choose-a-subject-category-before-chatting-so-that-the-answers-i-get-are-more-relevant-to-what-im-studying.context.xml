<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>As a student, I want to choose a subject category before chatting so that the answers I get are more relevant to what I'm studying.</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-as-a-student-i-want-to-choose-a-subject-category-before-chatting-so-that-the-answers-i-get-are-more-relevant-to-what-im-studying.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a student,</asA>
    <iWant>I want to choose a subject category before chatting,</iWant>
    <soThat>so that the answers I get are more relevant to what I'm studying.</soThat>
    <tasks>
- [ ] **Task 2.2.1: Implement Subject Selection UI (AC: 1)**
  - [ ] Add a subject selection component (e.g., dropdown from Shadcn UI) to the `WelcomeScreen`.
  - [ ] Populate subject options (e.g., "Biology", "Geology").
  - [ ] Ensure the component is clearly visible and selectable.
  - [ ] Add UI tests to verify the subject selection component is rendered and selectable.
- [ ] **Task 2.2.2: Store Subject Selection in Frontend State (AC: 2)**
  - [ ] Implement state management (e.g., React Context, Zustand) to store the user's selected subject.
  - [ ] Update the state when the user makes a selection.
  - [ ] Add unit/integration tests to verify the selected subject is correctly stored and updated in the frontend state.
- [ ] **Task 2.2.3: Pass Subject to Backend Chat API (AC: 3)**
  - [ ] Modify the frontend logic that sends chat messages to the `/api/chat` endpoint.
  - [ ] Include the selected subject in the `context` object of the request body.
  - [ ] Add integration tests to verify the selected subject is included in the `/api/chat` request payload.
- [ ] **Task 2.2.4: Backend Logic to Filter KB Search by Subject (AC: 4)**
  - [ ] Enhance the knowledge base search logic in the backend (Knowledge Base Service) to accept a `subject` parameter.
  - [ ] Use the `subject` parameter to filter the `pgvector` semantic search on the `knowledge_base_entries` table.
  - [ ] Add unit tests to verify subject-based filtering.
- [ ] **Task 2.2.5: AI Response Reflects Subject (AC: 5)**
  - [ ] Verify that the AI's generated response in the `/api/chat` endpoint is influenced by the subject context provided (e.g., by logging the final prompt sent to Gemini).
  - [ ] Conduct functional tests to ensure asking a subject-specific question with the correct subject selected yields a more relevant answer.
- [ ] **Task 2.2.6: Record Subject in `chat_sessions` Table (AC: 6)**
  - [ ] Modify the `/api/chat` endpoint to update the `chat_sessions` table with the selected `subject` for the current conversation.
  - [ ] Add integration tests to confirm the `subject` is correctly stored in the database.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  The `WelcomeScreen` (or equivalent initial UI) includes a visible and selectable UI element (e.g., dropdown, buttons) for choosing a subject category (e.g., "Biology", "Geology").
2.  When a user selects a subject category, this selection is stored in the frontend state.
3.  Given a subject category is selected,
    When a chat message is sent to the backend,
    Then the selected subject category is included in the `context` of the `/api/chat` request.
4.  The backend successfully uses the `subject` from the request context to filter semantic searches on the `knowledge_base_entries` table.
5.  The AI's generated response reflects the chosen subject category, making the answer more relevant.
6.  The `chat_sessions` table records the `subject` for the session.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <entry>
        <path>docs/fase-2-plan/PRD.md</path>
        <title>Product Requirements Document: Sentiabot</title>
        <section>Functional Requirements</section>
        <snippet>FR004: The user can choose a category within science (Biology &amp; Geology) to help narrow the context for the AI. FR007: The chatbot uses a dedicated knowledge base to ensure answers are based on approved content.</snippet>
      </entry>
      <entry>
        <path>docs/fase-2-plan/PRD.md</path>
        <title>Product Requirements Document: Sentiabot</title>
        <section>User Journeys</section>
        <snippet>Journey 1: Student Gets Help with Homework - Step 3: "They select their grade level ("4th Grade") and subject ("Biology") from a dropdown menu (FR004, FR005)." Step 5: "The chatbot processes the question, consulting its curated knowledge base (FR007)."</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Overview</section>
        <snippet>This epic aims to enhance the Sentiabot chatbot by connecting it to a dedicated knowledge base and allowing users to specify their context...</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Objectives and Scope</section>
        <snippet>Implement functionality for users to select a subject category (e.g., "Biology", "Geology") to narrow the AI's contextual understanding (FR004).</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: UI for Subject Selection</section>
        <snippet>The UI includes a visible and selectable element (e.g., dropdown, buttons) for choosing a subject category (e.g., "Biology", "Geology").</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: Frontend State Management</section>
        <snippet>When the selection is made, this selection is accurately stored in the frontend state.</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: Backend API Context Integration</section>
        <snippet>The selected subject category is included as `context.subject` in the request body when a chat message is sent to the backend.</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: Knowledge Base Filtering</section>
        <snippet>The `subject` from the request context is successfully used to filter the search on the `knowledge_base_entries` table.</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: AI Response Relevance</section>
        <snippet>The generated response reflects and is demonstrably more relevant to the chosen subject category.</snippet>
      </entry>
      <entry>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Knowledge-Driven, Contextual Chat</title>
        <section>Acceptance Criteria (Authoritative) - Story 2.2: Session Subject Recording</section>
        <snippet>The `chat_sessions` table records the chosen `subject` for that session.</snippet>
      </entry>
      <entry>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture / Data Models and Relationships</section>
        <snippet>The Sentiabot application will leverage PostgreSQL within Supabase to manage its data... `knowledge_base_entries` Table: `subject` field. `chat_sessions` Table: `subject` field.</snippet>
      </entry>
      <entry>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>API Contracts / Chat API (`/api/chat`)</section>
        <snippet>Handles user chat interactions with the AI. Request Body includes `context.subject`.</snippet>
      </entry>
      <entry>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>Epic to Architecture Mapping / Epic 2</section>
        <snippet>Supabase PostgreSQL (with `pgvector` extension), Next.js API Routes (knowledge base interaction, prompt generation), Google Gemini API (contextual prompts), Supabase Realtime (for dynamic updates).</snippet>
      </entry>
      <entry>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>AI Integration Strategy</section>
        <snippet>Implement a Retrieval-Augmented Generation (RAG) approach... `pgvector` for Knowledge Base: Storing the curated educational content as vector embeddings in PostgreSQL...</snippet>
      </entry>
      <entry>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns / Component-Based Development</section>
        <snippet>Build user interfaces from encapsulated, reusable components. Mentions `WelcomeScreen`.</snippet>
      </entry>
      <entry>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>User Journey Flows / Critical User Paths / Primary Journey: Asking a Science Question</section>
        <snippet>Screen 1: Welcome / Selection Screen: Describes "Subject" selector and how user selects it. Screen 2: Chat Screen: Describes how the selected context ("Science - Grade 3") is displayed in the header.</snippet>
      </entry>
      <entry>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>Component Library / Custom Components / `WelcomeScreen`</section>
        <snippet>The initial view of the application, containing the subject/grade selectors and the call to action to start the chat.</snippet>
      </entry>
      <entry>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>Component Library / Custom Components / `ChatBubble`</section>
        <snippet>This is the most critical custom component, responsible for displaying all conversational content. Mentions `SourcedLink`.</snippet>
      </entry>
      <entry>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>UX Pattern Decisions / Form Patterns (for Welcome Screen)</section>
        <snippet>Describes interaction with subject/grade level selectors. The primary "Start Chatting" button will be disabled by default and only enabled once both a subject and a grade level have been selected.</snippet>
      </entry>
    </docs>
    <code>
      <entry>
        <path>sentiabot/app/api/chat/route.ts</path>
        <kind>API Route</kind>
        <symbol>POST</symbol>
        <lines>6-30</lines>
        <reason>Core chat API endpoint, requires modification to accept `context.subject` and integrate knowledge base filtering.</reason>
      </entry>
      <entry>
        <path>sentiabot/lib/supabase.ts</path>
        <kind>Supabase Client</kind>
        <symbol>supabase</symbol>
        <lines>4-5</lines>
        <reason>Initializes the Supabase client, which will be used for interacting with `knowledge_base_entries` and `chat_sessions` tables.</reason>
      </entry>
      <entry>
        <path>sentiabot/components/</path>
        <kind>UI Component</kind>
        <symbol>WelcomeScreen (equivalent)</symbol>
        <lines></lines>
        <reason>Will house the subject selection UI element.</reason>
      </entry>
    </code>
    <dependencies>
      <node>
        <package name="supabase" version="^2.63.1" location="project-root"/>
        <package name="@google/generative-ai" version="^0.24.1"/>
        <package name="@radix-ui/react-slot" version="^1.2.4"/>
        <package name="@supabase/supabase-js" version="^2.86.0"/>
        <package name="@testing-library/user-event" version="^14.6.1"/>
        <package name="class-variance-authority" version="^0.7.1"/>
        <package name="clsx" version="^2.1.1"/>
        <package name="lucide-react" version="^0.555.0"/>
        <package name="next" version="16.0.6"/>
        <package name="react" version="19.2.0"/>
        <package name="react-dom" version="19.2.0"/>
        <package name="tailwind-merge" version="^3.4.0"/>
        <dev-package name="@tailwindcss/postcss" version="^4"/>
        <dev-package name="@testing-library/jest-dom" version="^6.9.1"/>
        <dev-package name="@testing-library/react" version="^16.3.0"/>
        <dev-package name="@types/node" version="^20"/>
        <dev-package name="@types/react" version="^19"/>
        <dev-package name="@types/react-dom" version="^19"/>
        <dev-package name="@vitejs/plugin-react" version="^5.1.1"/>
        <dev-package name="@vitest/coverage-v8" version="^4.0.14"/>
        <dev-package name="eslint" version="^9"/>
        <dev-package name="eslint-config-next" version="16.0.6"/>
        <dev-package name="jsdom" version="^27.2.0"/>
        <dev-package name="tailwindcss" version="^4"/>
        <dev-package name="tw-animate-css" version="^1.4.0"/>
        <dev-package name="typescript" version="^5"/>
        <dev-package name="vitest" version="^4.0.14"/>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <entry>
      <type>Frontend Architecture</type>
      <detail>UI components related to subject selection will be developed under `sentiabot/components/`, with `WelcomeScreen` or its equivalent being the primary location for the new UI element. Adherence to Component-Based Development and Atomic Design Principles is required.</detail>
    </entry>
    <entry>
      <type>Backend Architecture</type>
      <detail>The `/api/chat` route (`sentiabot/app/api/chat/route.ts`) must be updated to accept and process the `context.subject` parameter. The Knowledge Base Service (backend utility) needs enhancement for subject-based filtering on the `knowledge_base_entries` table. Utilize Supabase for PostgreSQL and `pgvector` for vector embeddings.</detail>
    </entry>
    <entry>
      <type>Database</type>
      <detail>The `chat_sessions` table needs to record the selected `subject` for each conversation. Ensure proper indexing for filtering if not already in place. Naming conventions (e.g., `snake_case` for database tables and columns) from `architecture.md` must be followed.</detail>
    </entry>
    <entry>
      <type>API Standards</type>
      <detail>The `/api/chat` endpoint should follow REST API patterns as defined in `architecture.md`.</detail>
    </entry>
    <entry>
      <type>AI Integration</type>
      <detail>Google Gemini API is the designated LLM. The RAG approach, using `pgvector` for knowledge base grounding, must incorporate subject context for relevant AI responses.</detail>
    </entry>
    <entry>
      <type>Coding Standards</type>
      <detail>Follow established project naming conventions (e.g., `PascalCase` for React components, `kebab-case` for file/folder names, `SCREAMING_SNAKE_CASE` for environment variables) as detailed in `architecture.md`.</detail>
    </entry>
  </constraints>
  <interfaces>
    <entry>
      <name>/api/chat POST</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/chat Request: {"message": "string", "context": {"subject": "string"}}</signature>
      <path>sentiabot/app/api/chat/route.ts</path>
    </entry>
  </interfaces>
  <tests>
    <standards>
      <paragraph>Testing standards for the project involve using `Vitest` as the test runner, with `React Testing Library` and `Jest DOM` for UI component testing, and `user-event` for simulating user interactions. Tests should be co-located with the source code they test, following `*.test.ts` or `*.spec.ts` naming conventions. Components should be testable and adhere to the single responsibility principle.</paragraph>
    </standards>
    <locations>
      <entry>sentiabot/**/*.test.ts</entry>
      <entry>sentiabot/**/*.spec.ts</entry>
    </locations>
    <ideas>
      <entry acId="1">UI tests for the `WelcomeScreen` (or equivalent) to ensure subject selection component is rendered and selectable.</entry>
      <entry acId="2">Unit/integration tests for frontend state management to verify selected subject is correctly stored and updated.</entry>
      <entry acId="3">Integration tests for the `/api/chat` endpoint to verify the selected subject is included in the request payload.</entry>
      <entry acId="4">Unit tests for backend knowledge base search logic to verify subject-based filtering.</entry>
      <entry acId="5">Functional tests to ensure AI responses are more relevant when subject context is provided.</entry>
      <entry acId="6">Integration tests to confirm the `subject` is correctly stored in the `chat_sessions` database table.</entry>
    </ideas>
  </tests>
</story-context>
