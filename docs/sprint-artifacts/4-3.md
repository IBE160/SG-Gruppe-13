# Story 4.3: Admin Modify Chatbot System Prompt

Status: drafted

## Story

As an Administrator,
I want to be able to modify the chatbot's system prompt,
so that I can refine its behavior and tone without needing to redeploy the application.

## Acceptance Criteria

1.  Given I am logged in as an administrator.
2.  I can see the current system prompt in a text editor.
3.  I can modify the prompt and save my changes.
4.  The next chat session uses the updated system prompt.

## Tasks / Subtasks

**AC 1: Given I am logged in as an administrator.**
-   [ ] (AC: #1) Implement secure administrator login.
    -   [ ] (AC: #1) Create admin login page (`/admin/login`).
    -   [ ] (AC: #1) Integrate Supabase Auth for login functionality. (Source: `architecture.md`, `tech-spec-epic-4.md`)
    -   [ ] (AC: #1) Protect `/admin` routes using authentication middleware/guards. (Source: `architecture.md`, `tech-spec-epic-4.md`)
    -   [ ] (AC: #1) Redirect unauthenticated users from `/admin` routes to login page.
    -   [ ] (AC: #1) **Testing:** Unit test `AdminLoginPage` component.
    -   [ ] (AC: #1) **Testing:** E2E test: Successful admin login and redirection to dashboard. (Source: `tech-spec-epic-4.md`)

**AC 2: I can see the current system prompt in a text editor.**
-   [ ] (AC: #2) Develop admin page to display system prompt.
    -   [ ] (AC: #2) Create admin page at `/admin/system-prompt`. (Source: `tech-spec-epic-4.md`)
    -   [ ] (AC: #2) Implement API endpoint `GET /api/admin/system-prompt` to fetch the current system prompt from `system_prompts` table. (Source: `architecture.md`, `tech-spec-epic-4.md`)
    -   [ ] (AC: #2) Create UI component (text editor, e.g., using `@radix-ui/react-textarea`) to display the `prompt_text`.
    -   [ ] (AC: #2) **Testing:** Unit test `GET /api/admin/system-prompt` endpoint. (Source: `tech-spec-epic-4.md`)
    -   [ ] (AC: #2) **Testing:** Unit test UI component for displaying prompt.

**AC 3: I can modify the prompt and save my changes.**
-   [ ] (AC: #3) Implement functionality to modify and save system prompt.
    -   [ ] (AC: #3) Implement API endpoint `PUT /api/admin/system-prompt` to update `prompt_text` in `system_prompts` table. (Source: `architecture.md`, `tech-spec-epic-4.md`)
    -   [ ] (AC: #3) Connect UI text editor to `PUT /api/admin/system-prompt` API endpoint.
    -   [ ] (AC: #3) Add save button and handle local state management for changes.
    -   [ ] (AC: #3) **Testing:** Unit test `PUT /api/admin/system-pompt` endpoint.

**AC 4: The next chat session uses the updated system prompt.**
-   [ ] (AC: #4) Ensure chatbot uses updated system prompt.
    -   [ ] (AC: #4) Modify the core chat API (`/api/chat`) to retrieve the latest system prompt from the `system_prompts` table before passing it to the AI model. (Source: `architecture.md`)
    -   [ ] (AC: #4) **Testing:** E2E test: Admin modifies prompt, starts a new chat, and verifies chatbot behavior reflects the new prompt. (Source: `tech-spec-epic-4.md`)

## Dev Notes

-   **Relevant architecture patterns and constraints:**
    -   Authentication: Supabase Auth for admin access.
    -   Data Persistence: System prompts stored in `system_prompts` table in Supabase PostgreSQL.
    -   API: RESTful endpoints `GET /api/admin/system-prompt` and `PUT /api/admin/system-prompt`.
    -   Security: RLS policies on `system_prompts` table to restrict access to administrators.
    -   System prompt is crucial for RAG and prompt engineering with Google Gemini.
-   **Source tree components to touch:**
    -   `src/app/admin/system-prompt` (new page and components for UI)
    -   `src/app/api/admin/system-prompt` (new API routes)
    -   `supabase/migrations` (for `system_prompts` table if not already existing)
    -   `src/lib/supabase.ts` (Supabase client integration)
    -   `src/app/api/chat` (existing chat API to retrieve latest system prompt)
-   **Testing standards summary:**
    -   Unit tests for UI components and API endpoints.
    -   Integration tests for UI-to-API interaction.
    -   E2E tests for full admin workflow and chatbot behavior change.
    -   Security testing for admin routes.

### Project Structure Notes

-   Admin interface under `/admin` routes.
-   API endpoints under `/api/admin`.
-   No detected conflicts or variances with existing structure.

### References

-   [Source: docs/fase-2-plan/PRD.md#FR011]
-   [Source: docs/fase-3-solutioning/architecture.md#system_prompts-table]
-   [Source: docs/sprint-artifacts/tech-spec-epic-4.md#Story-4.3]
-   [Source: docs/fase-2-plan/epics.md#Epic-4]
-   [Source: docs/fase-3-solutioning/architecture.md#Consistency-Rules]

## Change Log

- YYYY-MM-DD: Initial draft.

## Dev Agent Record

### Context Reference

docs/sprint-artifacts/4-3.context.xml

### Agent Model Used

gemini-1.5-flash

### Debug Log References

### Completion Notes List

### File List
